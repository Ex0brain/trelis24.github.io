Damn vulnerable app service: com.highaltitudehacks.dvia

Application directory (static data)
ps aux | grep -i AppName

Data directory (dynamic data)
cycript -p AppPID
[[[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask] lastObject];
/var/mobile/Containers/Data/Application/XXXXXXXXXXXXXXXXXXXXX/Documents/

Search text in files
grep -rnw '/path/to/somewhere/' -e 'pattern'

Search using regex
grep -E -O 'REGEX' -r *
https://www.regular-expressions.info/ip.html

Search files
find . -iname "*PATTERN*"
.plist
.sql
.db

Read plist
plutil FILE.plist | less

Convert plist to xml
plutil -convert xml1 Info.plist -o output


Insecure Data Storage
Coses a mirar:
	Info sensible a plist, db i sql
	NSUserDefaults
		One of the most common ways of saving user preferences and properties in an application is by using NSUserDefaults. The information stored in NSUserDefaults persists even if you close the application and start it again. 
		Permet gestionar valors per defecte així com les preferencies d'usuari. L'informació guardada amb aquesta classe no s'encripta.
		Library -> Preferences -> $AppBundleId.plist
	Keychain
		It is a sqlite database located at /private/var/Keychains/keychain-2.db
		Using keychain_dumper
		INVESTIGAR FINS A QUIN PUNT ÉS SEGUR
			NSFileProtectionComplete: accessible quan està desbloquejat (requereix pin de l'usuari). Important que els arxius tinguin aquesta opció, ja que sinó al fer backups a l'iCloud i iTunes es possible accedir a l'informació sensible.
			kSecAtrAccessibleAfterFirstUnlock: accessible quan es desbloqueja per primera vegada
			kSecAttrAccessibleAlways: sempre accessible
			kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly: accessible quan el móbil està desbloquejat i s'ha introduit el passcode
		Lo ideal és que la informació sensible es guardi al servidor i no al keychain.
		Per extreure la info mirar el keychain amb la app corrent i sense i amb el dispositiu apagat i encés.
	Core Data (Ztables)
		Coredata.sqlite
		Use sqlite3
		select * from TABLE
		ZUSER és la taula a mirar. Les altres dues es creen per defecte.
		Revisar-ho abans i després del test, ja que hi ha moltes plist que es generen quan l'usuari executa accions.
	Webkit Caching
		Aplicacions que utilitzen UIWebView potser guarden en cache informació sensible.
		El nom de la taula on es guarda és "cf_url"
		INVESTIGAR

iOS implementations Insecurities
	Keyboard
		DATA/Library/Keyboard/dynamic-text.dat 	
	Pasteboard Leakage
		/private/var/mobile/Library/Caches/com.apple.UIKit.pboard
		Provar de copiar dades sensibles (que surti l'opció)
		Amb cycript:
			[UIPasteboard generalPasteboard].items
	Snapshots
		/DATA/Library/Caches/Snapshots
	Cookies
		DATA/Library/Cookies/
		Usar BinaryCookieReader.py per veure'n el contingut
	Device Logging
		socat/watch -UNIX -CONNECT /var/run/lockdown/syslog.sock
		tail -f /var/log/syslog

Binary analyzer
	Binary structure
		otool -hv app
		Mach-O està format per: 
			- Header: informació bàsica
			- Load commands: comandes que s'executen
			- Data
	Position Independent Executable (PIE)
		otool -hv app
			Mirar si hi ha PIE al Mach-O Header
		Funcionalitat de seguretat que permet a l'aplicació usar ASLR. S'ha d'afegir el flag -fPIE -pie.
	Stack Smashing Protections
		Permet carregar un valor conegut a l'stack abans de carregar les variables d'aplicació. D'aquesta manera és possible detectar i protegir els punters claus i arguments de funcions contra buffers overflows.
		otool -I -v app | grep stack
			stack_chk_fail
			stack_chk_guard
	Automatic Reference Countig (ARC)
		Fa que el compilador gestioni la memòria reduïnt així la possibilitat de que l'aplicació provoqui corrupció de memòria.
		otool -I -v app | grep _objc_
			_objc_retain
			_objc_release
			_objc_storeStrong
			_objc_releaseReturnValue
			_objc_autoreleaseReturnValue
			_objc_retainAutoreleaseReturnValue
	Decrypting iOS Binaries
		otool -arch all -Vl app | grep -A5 LC_ENCRYPT
		Clutch -i -> llista
		Clutch -b id
		Pot ser que surti un error a l'utiltizar clutch si l'aplicació depén d'altres binaris que usen un sistema d'encriptació diferent. Si és així, es poden eliminar, desxifrar l'aplicació i tornar-los a afegir. Sinó s'ha de reinstalar la app.
	Class dump
		Permet obtenir les classes i atributs de l'aplicació

Cycript
	Ver objetos del webview:
		UIApp.keyWindow .recursiveDescription().toString()
	Para acceder a objetos individuales i navegar por los distintos paneles del webview:
		UIApp.Windows[0].subviews()[0].subviews()
	Seleccionar un botón:
		var button = UIAppWindows[0].subviews()[0].subviews()[4]
	Para ver la función que usa el objeto:
		var target = button.allTargets().allObjects()[0]
	Para ver la función a la que llama el botón:
		[button actionsForTarget:target forControlEvent:UIControlEventTouchUpInside]
	Seleccinar/veure contingut de les variables:
		target.<nom_variable>
	Llamar funciones
		[target <function>:<atributo>]
	Root view controller
		UIApp.KeyWindows.rootViewController